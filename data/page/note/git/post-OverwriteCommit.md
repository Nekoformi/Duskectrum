---
title: Overwrite Commit
date: 2024/04/15
author: Nekoformi
---

# Overwrite Commit

リポジトリーの奥底で眠っていた古のコミットに過ちが発覚しても絶望しないでください！　過去のコミットや歴史を操作する方法があります！

## 過去のコミットを上書きする

前回のコミットを修正したい場合や特定のコミットへ遡り内容を上書きしたい（それ以降の変更を対象に纏める）場合は、以下の操作を行います。

1. 特定のコミット（まで）をリセット：`reset`で取り消します。
    - コミットIDについては`log`で確認できます。
    - `HEAD`は現在のブランチの地点を示すものであり、`HEAD~n`でn世代前のコミット（n世代目の親コミット）を指定することができます。
    - 最初のコミットを対象とする場合は`update-ref`を使用する必要があります。

```sh:Bash
// 直前のコミットを対象とする場合
$ git reset --soft HEAD~

// 特定のコミット（まで）を対象とする場合
$ git reset --soft コミットID

// 最初のコミット（まで）を対象とする場合
$ git update-ref -d HEAD
```

2. 内容を編集してステージング：`add`します。今回はオプション：`--soft`を指定しているので、上記のコマンドを実行する前に作業が完了している（ステージングされている）場合はそのまま次へ進みます。

```sh:Bash
$ git add .
```

3. コミット：`commit`します。

```sh:Bash
$ git commit --amend
```

4. プッシュ：`push`します。破壊的な操作なのでオプション：`--force`を付与する必要があります。

```sh:Bash
$ git push --force origin
```

5. 無事にコミットが上書きされました。

## 歴史を改変する

今までのコミットを取り消すのではなく、特定のコミットを上書きする（初めから修正された内容が存在した状態で以降のコミットが構成されるようにする）場合は、以下の操作を行います。

1. リベース：`rebase`で上書きしたいコミットへ戻ります。この時、対象のコミットIDではなく対象の親のコミットIDを指定してください！
    - オプション：`-i`で対話的（直感的）に操作を指定することができます。
    - 最初のコミットまで遡る場合はコミットIDではなくオプション：`--root`を使用する必要があります。

```sh:Bash
// 特定のコミットに遡る場合
$ git rebase -i コミットID

// 最初のコミットに遡る場合
$ git rebase -i --root
```

2. 設定したエディターに応じて（nanoやviの場合はターミナル上で、Visual Studio Code等のIDEを指定している場合は出力されたファイルで）上書きしたい地点を指定します。保存して閉じることで処理が始まります。
3. 内容を編集してステージング：`add`します。

```sh:Bash
$ git add .
```

4. コミット：`commit`します。

```sh:Bash
$ git commit --amend
```

5. リベース：`rebase`します。コンフリクト（衝突）が起きた場合は解消してからリベースを再開しましょう。

```sh:Bash
$ git rebase --continue
```

6. プッシュ：`push`します。破壊的な操作なのでオプション：`--force`を付与する必要があります。

```sh:Bash
$ git push --force origin
```

7. 無事に歴史が改変されました。
